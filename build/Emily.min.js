/*
 Emily <VERSION> http://flams.github.com/emily

 The MIT License (MIT)

 Copyright (c) 2012-2013 Olivier Scherrer <pode.fr@gmail.com>
*/
define("Tools",[],function(){function i(a,b,c){var d,e;if(b)return b.forEach(function(b,f){var h=c(b,a);if(h>=0&&(typeof e=="undefined"||h<e))e=h,d=f}),d}return{getGlobal:function(){return function(){return this}.call(null)},mixin:function(a,b,c){this.loop(a,function(d,e){if(!b[e]||!c)b[e]=a[e]});return b},count:function(a){var b=0;this.loop(a,function(){b++});return b},compareObjects:function(a,b){return Object.getOwnPropertyNames(a).sort().join("")==Object.getOwnPropertyNames(b).sort().join("")},
compareNumbers:function(a,b){return a>b?1:a<b?-1:0},toArray:function(a){return[].slice.call(a)},loop:function(a,b,c){var d;if(a instanceof Object&&b instanceof Function){if(a instanceof Array)for(d=0;d<a.length;d++)b.call(c,a[d],d,a);else for(d in a)a.hasOwnProperty(d)&&b.call(c,a[d],d,a);return true}else return false},objectsDiffs:function(a,b){if(a instanceof Object&&b instanceof Object){var c=[],d=[],e=[],g=[];this.loop(b,function(b,h){typeof a[h]=="undefined"?g.push(h):b!==a[h]?d.push(h):b===
a[h]&&c.push(h)});this.loop(a,function(a,h){typeof b[h]=="undefined"&&e.push(h)});return{updated:d,unchanged:c,added:g,deleted:e}}else return false},jsonify:function(a){return a instanceof Object?JSON.parse(JSON.stringify(a)):false},clone:function(a){return a instanceof Array?a.slice(0):typeof a=="object"&&a!==null&&!(a instanceof RegExp)?this.mixin(a,{}):false},getNestedProperty:function(a,b){return a&&a instanceof Object?typeof b=="string"&&b!==""?b.split(".").reduce(function(a,b){return a&&a[b]},
a):typeof b=="number"?a[b]:a:a},setNestedProperty:function(a,b,c){if(a&&a instanceof Object)if(typeof b=="string"&&b!==""){var d=b.split(".");return d.reduce(function(a,b,f){a[b]=a[b]||{};d.length==f+1&&(a[b]=c);return a[b]},a)}else return typeof b=="number"?(a[b]=c,a[b]):a;else return a},closest:function(a,b){return i(a,b,function(a,b){return Math.abs(a-b)})},closestGreater:function(a,b){return i(a,b,function(a,b){return a-b})},closestLower:function(a,b){return i(a,b,function(a,b){return b-a})}}});
define("Observable",["Tools"],function(i){return function(){var a={};this.watch=function(b,c,d){if(typeof c=="function"){var e=a[b]=a[b]||[],c=[c,d];e.push(c);return[b,e.indexOf(c)]}else return false};this.unwatch=function(b){var c=b[0],b=b[1];return a[c]&&a[c][b]?(delete a[c][b],a[c].some(function(a){return!!a})||delete a[c],true):false};this.notify=function(b){var c=a[b],d=i.toArray(arguments).slice(1);return c?(i.loop(c,function(a){try{a&&a[0].apply(a[1]||null,d)}catch(b){}}),true):false};this.hasObserver=
function(b){return!(!b||!a[b[0]]||!a[b[0]][b[1]])};this.hasTopic=function(b){return!!a[b]};this.unwatchAll=function(b){a[b]?delete a[b]:a={};return true}}});
define("StateMachine",["Tools"],function(i){function a(){var a={};this.add=function(c,d,e,g){var f=[];if(a[c])return false;return typeof c=="string"&&typeof d=="function"?(f[0]=d,typeof e=="object"&&(f[1]=e),typeof e=="string"&&(f[2]=e),typeof g=="string"&&(f[2]=g),a[c]=f,true):false};this.has=function(c){return!!a[c]};this.get=function(c){return a[c]||false};this.event=function(c){var d=a[c];return d?(d[0].apply(d[1],i.toArray(arguments).slice(1)),d[2]):false}}return function(b,c){var d={},e="";
this.init=function(a){return d[a]?(e=a,true):false};this.add=function(b){return d[b]?d[b]:d[b]=new a};this.get=function(a){return d[a]};this.getCurrent=function(){return e};this.has=function(a){return d.hasOwnProperty(a)};this.advance=function(a){return this.has(a)?(e=a,true):false};this.event=function(a){var b;b=d[e].event.apply(d[e].event,i.toArray(arguments));return b===false?false:(b&&(d[e].event("exit"),e=b,d[e].event("entry")),true)};i.loop(c,function(a,b){var h=this.add(b);a.forEach(function(a){h.add.apply(null,
a)})},this);this.init(b)}});
define("Promise",["Observable","StateMachine"],function(i,a){return function c(){var d=null,e=null,g=new i,f={Pending:[["fulfill",function(a){d=a;g.notify("fulfill",a)},"Fulfilled"],["reject",function(a){e=a;g.notify("reject",a)},"Rejected"],["toFulfill",function(a){g.watch("fulfill",a)}],["toReject",function(a){g.watch("reject",a)}]],Fulfilled:[["toFulfill",function(a){setTimeout(function(){a(d)},0)}]],Rejected:[["toReject",function(a){setTimeout(function(){a(e)},0)}]]},h=new a("Pending",f);this.fulfill=
function(a){h.event("fulfill",a);return this};this.reject=function(a){h.event("reject",a);return this};this.then=function(a,f,g,i){var j=new c;a instanceof Function?f instanceof Function?h.event("toFulfill",this.makeResolver(j,a)):h.event("toFulfill",this.makeResolver(j,a,f)):h.event("toFulfill",this.makeResolver(j,function(){j.fulfill(d)}));f instanceof Function&&h.event("toReject",this.makeResolver(j,f,g));g instanceof Function&&h.event("toReject",this.makeResolver(j,g,i));!(f instanceof Function)&&
!(g instanceof Function)&&h.event("toReject",this.makeResolver(j,function(){j.reject(e)}));return j};this.sync=function(a){return a instanceof Object&&a.then?(a.then(function(a){this.fulfill(a)}.bind(this),function(a){this.reject(a)}.bind(this)),true):false};this.makeResolver=function(a,h,c){return function(d){var f;try{f=h.call(c,d),a.sync(f)||a.fulfill(f)}catch(e){a.reject(e)}}};this.getReason=function(){return e};this.getValue=function(){return d};this.getObservable=function(){return g};this.getStateMachine=
function(){return h};this.getStates=function(){return f}}});
define("Store",["Observable","Tools"],function(i,a){return function(b){var c=a.clone(b)||{},d=new i,e=new i,g=[],f=function(b){var f=a.objectsDiffs(b,c);["updated","deleted","added"].forEach(function(a){f[a].forEach(function(b){d.notify(a,b,c[b]);e.notify(b,c[b],a)})})};this.count=this.getNbItems=function(){return c instanceof Array?c.length:a.count(c)};this.get=function(a){return c[a]};this.has=function(a){return c.hasOwnProperty(a)};this.set=function(a,b){var f,g;return typeof a!="undefined"?(f=
this.has(a),g=this.get(a),c[a]=b,f=f?"updated":"added",d.notify(f,a,c[a],g),e.notify(a,c[a],f,g),true):false};this.update=function(b,c,f){var g;return this.has(b)?(g=this.get(b),a.setNestedProperty(g,c,f),d.notify("updated",c,f),e.notify(b,g,"updated"),true):false};this.del=function(a){return this.has(a)?(this.alter("splice",a,1)||(delete c[a],d.notify("deleted",a),e.notify(a,c[a],"deleted")),true):false};this.delAll=function(b){return b instanceof Array?(b.sort(a.compareNumbers).reverse().forEach(this.del,
this),true):false};this.alter=function(b){var d,e;return c[b]?(e=a.clone(c),d=this.proxy.apply(this,arguments),f(e),d):false};this.proxy=function(a){return c[a]?c[a].apply(c,Array.prototype.slice.call(arguments,1)):false};this.watch=function(a,b,c){return d.watch(a,b,c)};this.unwatch=function(a){return d.unwatch(a)};this.getStoreObservable=function(){return d};this.watchValue=function(a,b,c){return e.watch(a,b,c)};this.unwatchValue=function(a){return e.unwatch(a)};this.getValueObservable=function(){return e};
this.loop=function(b,d){a.loop(c,b,d)};this.reset=function(b){if(b instanceof Object){var d=a.clone(c);c=a.clone(b)||{};f(d);return true}else return false};this.compute=function(b,c,d,f){return typeof b=="string"&&typeof c=="object"&&typeof d=="function"&&!this.isCompute(b)?(g[b]=[],a.loop(c,function(a){g[b].push(this.watchValue(a,function(){this.set(b,d.call(f))},this))},this),this.set(b,d.call(f)),true):false};this.removeCompute=function(b){return this.isCompute(b)?(a.loop(g[b],function(a){this.unwatchValue(a)},
this),this.del(b),true):false};this.isCompute=function(a){return!!g[a]};this.toJSON=function(){return JSON.stringify(c)};this.dump=function(){return c}}});
define("Transport",[],function(){return function(i){var a=null;this.setReqHandlers=function(b){return b instanceof Object?(a=b,true):false};this.getReqHandlers=function(){return a};this.request=function(b,c,d,e){return a.has(b)&&typeof c!="undefined"?(a.get(b)(c,function(){d&&d.apply(e,arguments)}),true):false};this.listen=function(b,c,d,e){if(a.has(b)&&typeof c!="undefined"&&typeof d=="function"){var g=function(){d.apply(e,arguments)},f;f=a.get(b)(c,g,g);return function(){typeof f=="function"?f():
typeof f=="object"&&typeof f.func=="function"&&f.func.call(f.scope)}}else return false};this.setReqHandlers(i)}});
define("Router",["Observable","Store"],function(i,a){return function(){var b=new i,c=new i,d=new a([]),e=-1,g=10;this.getRoutesObservable=function(){return b};this.getEventsObservable=function(){return c};this.setMaxHistory=function(a){return a>=0?(g=a,true):false};this.getMaxHistory=function(){return g};this.set=function(){return b.watch.apply(b,arguments)};this.unset=function(a){return b.unwatch(a)};this.navigate=function(a,b){return this.load(a,b)?(d.proxy("splice",e+1,d.count()),d.proxy("push",
{route:a,params:b}),this.ensureMaxHistory(d),e=d.count()-1,true):false};this.ensureMaxHistory=function(a){var b=a.count(),c=this.getMaxHistory();b-=c;b>0&&a.proxy("splice",0,b)};this.load=function(a,d){return b.notify(a,d)?(c.notify("route",a,d),true):false};this.watch=function(a,b){return c.watch("route",a,b)};this.unwatch=function(a){return c.unwatch(a)};this.getHistoryStore=function(){return d};this.getHistoryCount=function(){return d.count()};this.clearHistory=function(){d.reset([])};this.go=
function(a){var b=d.get(e+a);return b?(e+=a,this.load(b.route,b.params),true):false};this.back=function(){return this.go(-1)};this.forward=function(){return this.go(1)}}});
