define("CouchDBStore",["Store","StateMachine","Tools","Promise"],function(e,f,d,c){function b(){var g=null,h=null,a=null,b=null,e=null,d={},j=new c,i=new f("Unsynched",{Unsynched:[["getView",function(){g.request("CouchDB",{method:"GET",path:"/"+h+"/_design/"+e+"/_view/"+a+"?update_seq=true"},function(a){a=JSON.parse(a);d={total_rows:a.total_rows,update_seq:a.update_seq,offset:a.offset};this.reset(a.rows);i.event("subscribeToViewChanges",a.update_seq)},this)},this,"Synched"],["getDocument",function(){g.request("CouchDB",
{method:"GET",path:"/"+h+"/"+b},function(a){a=JSON.parse(a);a._id?(this.reset(a),i.event("subscribeToDocumentChanges")):j.reject(this)},this)},this,"Synched"]],Synched:[["updateDatabase",function(){g.request("CouchDB",{method:"PUT",path:"/"+h+"/"+b,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(){i.event("subscribeToDocumentChanges")})},this],["subscribeToViewChanges",function(a){g.listen("CouchDB","/"+h+"/_changes?feed=continuous&heartbeat=20000&since="+a,function(a){if(a==
"\n")return false;var a=JSON.parse(a),b;b=a.deleted?"delete":a.changes[0].rev.search("1-")==0?"add":"change";i.event(b,a.id)},this)},this,"Listening"],["subscribeToDocumentChanges",function(){g.listen("CouchDB","/"+h+"/_changes?feed=continuous&heartbeat=20000",function(a){if(a=="\n")return false;a=JSON.parse(a);a.id==b&&a.changes.pop().rev!=this.get("_rev")&&(a.deleted?i.event("deleteDoc"):i.event("updateDoc"))},this)},this,"Listening"]],Listening:[["entry",function(){j.resolve(this)},this],["change",
function(b){g.request("CouchDB",{method:"GET",path:"/"+h+"/_design/"+e+"/_view/"+a},function(a){JSON.parse(a).rows.some(function(a,h){a.id==b&&this.set(h,a)},this)},this)},this],["delete",function(a){this.loop(function(b,h){b.id==a&&this.del(h)},this)},this],["add",function(b){g.request("CouchDB",{method:"GET",path:"/"+h+"/_design/"+e+"/_view/"+a},function(a){JSON.parse(a).rows.some(function(a,h){a.id==b&&this.alter("splice",h,0,a)},this)},this)},this],["updateDoc",function(){g.request("CouchDB",
{method:"GET",path:"/"+h+"/"+b},function(a){this.reset(JSON.parse(a))},this)},this],["deleteDoc",function(){this.reset({})},this],["updateDatabase",function(){g.request("CouchDB",{method:"PUT",path:"/"+h+"/"+b,headers:{"Content-Type":"application/json"},data:this.toJSON()})},this],["removeFromDatabase",function(){g.request("CouchDB",{method:"DELETE",path:"/"+h+"/"+b+"?rev="+this.get("_rev")})},this]]});this.sync=function(c,g,d){if(typeof c=="string"&&typeof g=="string"&&typeof d=="string")return h=
c,e=g,a=d,i.event("getView"),j;else if(typeof c=="string"&&typeof g=="string"&&typeof d=="undefined")return h=c,b=g,i.event("getDocument"),j;return false};this.update=function(){return i.event("updateDatabase")};this.remove=function(){return i.event("removeFromDatabase")};this.getDBInfo=function(a){return d[a]};this.setTransport=function(a){return a&&typeof a.listen=="function"&&typeof a.request=="function"?(g=a,true):false};this.getStateMachine=function(){return i};this.getTransport=function(){return g}}
return function(){b.prototype=new e;return new b}});
define("Observable",["Tools"],function(e){return function(){var f={};this.watch=function(d,c,b){if(typeof c=="function"){var g=f[d]=f[d]||[];observer=[c,b];g.push(observer);return[d,g.indexOf(observer)]}else return false};this.unwatch=function(d){var c=d[0],d=d[1];return f[c]&&f[c][d]?(delete f[c][d],f[c].some(function(b){return!!b})||delete f[c],true):false};this.notify=function(d){var c=f[d],b;if(c){for(b=c.length;b--;)c[b]&&c[b][0].apply(c[b][1]||null,e.toArray(arguments).slice(1));return true}else return false};
this.hasObserver=function(d){return!(!d||!f[d[0]]||!f[d[0]][d[1]])};this.hasTopic=function(d){return!!f[d]};this.unwatchAll=function(d){f[d]?delete f[d]:f={};return true}}});
define("Promise",["Observable","StateMachine"],function(e,f){return function(){var d,c,b=new f("Unresolved",{Unresolved:[["resolve",function(b){d=b;g.notify("success",b)},"Resolved"],["reject",function(b){c=b;g.notify("fail",b)},"Rejected"],["addSuccess",function(b,a){g.watch("success",b,a)}],["addFail",function(b,a){g.watch("fail",b,a)}]],Resolved:[["addSuccess",function(b,a){b.call(a,d)}]],Rejected:[["addFail",function(b,a){b.call(a,c)}]]}),g=new e;this.resolve=function(c){return b.event("resolve",
c)};this.reject=function(c){return b.event("reject",c)};this.then=function(c,a,g,d){c instanceof Function&&(a instanceof Function?b.event("addSuccess",c):b.event("addSuccess",c,a));a instanceof Function&&b.event("addFail",a,g);g instanceof Function&&b.event("addFail",g,d);return this};this.getObservable=function(){return g};this.getStateMachine=function(){return b}}});
define("StateMachine",["Tools"],function(e){function f(){var d={};this.add=function(c,b,g,e){var a=[];if(d[c])return false;return typeof c=="string"&&typeof b=="function"?(a[0]=b,typeof g=="object"&&(a[1]=g),typeof g=="string"&&(a[2]=g),typeof e=="string"&&(a[2]=e),d[c]=a,true):false};this.has=function(c){return!!d[c]};this.event=function b(b){var g=d[b];return g?(g[0].apply(g[1],e.toArray(arguments).slice(1)),g[2]):false}}return function(d,c){var b={},g="";this.init=function(c){return b[c]?(g=c,
true):false};this.add=function(c){return b[c]?false:b[c]=new f};this.get=function(c){return b[c]};this.getCurrent=function(){return g};this.event=function(c){var a;a=b[g].event.apply(b[g].event,e.toArray(arguments));return a===false?false:(a&&(b[g].event("exit"),g=a,b[g].event("entry")),true)};e.loop(c,function(b,a){var c=this.add(a);b.forEach(function(a){c.add.apply(null,a)})},this);this.init(d)}});
define("Store",["Observable","Tools"],function(e,f){return function(d){var c=f.clone(d)||{},b=new e,g=new e,h=function(a){var d=f.objectsDiffs(a,c);["updated","deleted","added"].forEach(function(a){d[a].forEach(function(d){b.notify(a,d,c[d]);g.notify(d,c[d])})})};this.getNbItems=function(){return c instanceof Array?c.length:f.count(c)};this.get=function(a){return c[a]};this.has=function(a){return c.hasOwnProperty(a)};this.set=function(a,d){var e;return typeof a!="undefined"?(e=this.has(a),c[a]=d,
b.notify(e?"updated":"added",a,c[a]),g.notify(a,c[a]),true):false};this.del=function(a){return this.has(a)?(this.alter("splice",a,1)||(delete c[a],b.notify("deleted",a),g.notify(a)),true):false};this.alter=function(a){var b,d;return c[a]?(d=f.clone(c),b=c[a].apply(c,Array.prototype.slice.call(arguments,1)),h(d),b):false};this.watch=function(a,c,d){return b.watch(a,c,d)};this.unwatch=function(a){return b.unwatch(a)};this.getStoreObservable=function(){return b};this.watchValue=function(a,b,c){return g.watch(a,
b,c)};this.unwatchValue=function(a){return g.unwatch(a)};this.getValueObservable=function(){return g};this.loop=function(a,b){f.loop(c,a,b)};this.reset=function(a){if(a instanceof Object){var b=f.clone(c);c=f.clone(a)||{};h(b);return true}else return false};this.toJSON=function(){return JSON.stringify(c)}}});
define("Tools",function(){return{getGlobal:function(){return function(){return this}.call(null)},mixin:function(e,f,d){this.loop(e,function(c,b){if(!f[b]||!d)f[b]=e[b]});return f},count:function(e){var f=0;this.loop(e,function(){f++});return f},compareObjects:function(e,f){return Object.getOwnPropertyNames(e).sort().join("")==Object.getOwnPropertyNames(f).sort().join("")},toArray:function(e){return Array.prototype.slice.call(e)},loop:function(e,f,d){var c,b;if(e instanceof Object&&typeof f=="function"){if(b=
e.length)for(c=0;c<b;c++)f.call(d,e[c],c,e);else for(c in e)e.hasOwnProperty(c)&&f.call(d,e[c],c,e);return true}else return false},objectsDiffs:function(e,f){if(e instanceof Object&&f instanceof Object){var d=[],c=[],b=[],g=[];this.loop(f,function(b,a){b!==e[a]&&typeof e[a]!="undefined"?c.push(a):b===e[a]?d.push(a):typeof e[a]=="undefined"&&g.push(a)});this.loop(e,function(c,a){typeof f[a]=="undefined"&&b.push(a)});return{updated:c,unchanged:d,added:g,deleted:b}}else return false},jsonify:function(e){return e instanceof
Object?JSON.parse(JSON.stringify(e)):false},clone:function(e){return e instanceof Array?e.slice(0):typeof e=="object"&&e!==null&&!(e instanceof RegExp)?this.mixin(e,{}):e},getNestedProperty:function(e,f){if(e&&e instanceof Object&&typeof f=="string"&&f!=""){var d=f.split(".");d.unshift(e);return d.reduce(function(c,b){return c[b]})}else return e}}});
define("Transport",["Observable"],function(e){return function(f){var d=null,c=io,b=new e;this.connect=function(b){d=c.connect(b);return!!d};this.getSocket=function(){return d};this.on=function(b,c){d.on(b,c)};this.once=function(b,c){d.once(b,c)};this.emit=function(b,c,a){d.emit(b,c,a)};this.request=function(b,c,a,e){var f=Date.now()+Math.floor(Math.random()*1E6),k=function(){a&&a.apply(e||null,arguments)};d[c.keptAlive?"on":"once"](f,k);c.__eventId__=f;d.emit(b,c);if(c.keptAlive)return function(){d.removeListener(f,
k)}};this.listen=function(c,d,a,e){var f=c+"/"+d,k,j;b.hasTopic(f)||(j=this.request(c,{path:d,method:"GET",keptAlive:true},function(a){b.notify(f,a)},this));k=b.watch(f,a,e);return{stop:function(){b.unwatch(k);b.hasTopic(f)||j()}}};this.getListenObservable=function(){return b};this.connect(f)}});
