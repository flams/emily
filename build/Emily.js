define("CouchDBStore",["Store","StateMachine","Tools"],function(b,c){function g(){var a=null,d=null,b=null,e=null,h=null,g={},i=new c("Unsynched",{Unsynched:[["getView",function(){a.request("CouchDB",{method:"GET",path:"/"+d+"/_design/"+h+"/_view/"+b+"?update_seq=true"},function(a){a=JSON.parse(a);g={total_rows:a.total_rows,update_seq:a.update_seq,offset:a.offset};this.reset(a.rows);i.event("subscribeToViewChanges",a.update_seq)},this)},this,"Synched"],["getDocument",function(){a.request("CouchDB",
{method:"GET",path:"/"+d+"/"+e},function(a){this.reset(JSON.parse(a));i.event("subscribeToDocumentChanges")},this)},this,"Synched"]],Synched:[["subscribeToViewChanges",function(e){a.listen("CouchDB",{method:"GET",path:"/"+d+"/_changes?feed=continuous&heartbeat=20000&since="+e},function(a){if(a=="\n")return false;var a=JSON.parse(a),e;e=a.deleted?"delete":a.changes[0].rev.search("1-")==0?"add":"change";i.event(e,a.id)},this)},this,"Listening"],["subscribeToDocumentChanges",function(){a.listen("CouchDB",
{method:"GET",path:"/"+d+"/_changes?feed=continuous&heartbeat=20000"},function(a){if(a=="\n")return false;a=JSON.parse(a);a.id==e&&(a.deleted?i.event("deleteDoc"):i.event("updateDoc"))},this)},this,"Listening"]],Listening:[["change",function(e){a.request("CouchDB",{method:"GET",path:"/"+d+"/_design/"+h+"/_view/"+b},function(a){JSON.parse(a).rows.some(function(a,d){a.id==e&&this.set(d,a)},this)},this)},this],["delete",function(a){this.loop(function(e,d){e.id==a&&this.del(d)},this)},this],["add",function(e){a.request("CouchDB",
{method:"GET",path:"/"+d+"/_design/"+h+"/_view/"+b},function(a){JSON.parse(a).rows.some(function(a,d){a.id==e&&this.alter("splice",d,0,a)},this)},this)},this],["updateDoc",function(){a.request("CouchDB",{method:"GET",path:"/"+d+"/"+e},function(a){this.reset(JSON.parse(a))},this)},this],["deleteDoc",function(){this.reset({})},this]]});this.sync=function(a,c,g){if(typeof a=="string"&&typeof c=="string"&&typeof g=="string")return d=a,h=c,b=g,i.event("getView"),true;else if(typeof a=="string"&&typeof c==
"string"&&typeof g=="undefined")return d=a,e=c,i.event("getDocument"),true;return false};this.getDBInfo=function(a){return g[a]};this.setTransport=function(e){return e&&typeof e.listen=="function"&&typeof e.request=="function"?(a=e,true):false};this.getState=function(){return i.getCurrent()};this.getTransport=function(){return a}}return function(){g.prototype=new b;return new g}});
define("Observable",["Tools"],function(b){return function(){var c={};this.watch=function(b,a,d){if(typeof a=="function"){var f=c[b]=c[b]||[];observer=[a,d];f.push(observer);return[b,f.indexOf(observer)]}else return false};this.unwatch=function(b){var a=b[0],b=b[1];return c[a]&&c[a][b]?(c[a][b]=null,true):false};this.notify=function(g){var a=c[g],d;if(a){for(d=a.length;d--;)a[d]&&a[d][0].apply(a[d][1]||null,b.toArray(arguments).slice(1));return true}else return false};this.hasObserver=function(b){return!(!b||
!c[b[0]]||!c[b[0]][b[1]])};this.unwatchAll=function(b){c[b]?delete c[b]:c={};return true}}});
define("Promise",["StateMachine","Observable","Tools"],function(b,c,g){return function(a,d){var f=null,e=null,h=null,j=null,i=new c;_stateMachine=new b("Unresolved",{Unresolved:[["resolve",function(){f.call(e,function(){return _stateMachine.event.apply(_stateMachine,g.toArray(arguments))})}],["success",function(a){h=a;i.notify("success",a)},"Resolved"],["fail",function(a){j=a;i.notify("fail",a)},"Failed"],["addThen",function(a,e,b){i.watch(a,e,b)}]],Resolved:[["addThen",function(a,e,b){e.call(b,a==
"success"?h:j)}]],Failed:[["addThen",function(a,e,b){e.call(b,a=="success"?h:j)}]]});this.then=function(a,e,b,d){a instanceof Function&&(e instanceof Function?_stateMachine.event("addThen","success",e):_stateMachine.event("addThen","success",a,e));e instanceof Function&&_stateMachine.event("addThen","fail",e,b);b instanceof Function&&_stateMachine.event("addThen","fail",b,d)};this.resolve=function(){return!(!f||!_stateMachine.event("resolve"))};this.getState=function(){return _stateMachine.getCurrent()};
a instanceof Function&&(f=a,e=d)}});
define("StateMachine",["Tools"],function(b){function c(){var c={};this.add=function(a,b,f,e){var h=[];if(c[a])return false;return typeof a=="string"&&typeof b=="function"?(h[0]=b,typeof f=="object"&&(h[1]=f),typeof f=="string"&&(h[2]=f),typeof e=="string"&&(h[2]=e),c[a]=h,true):false};this.has=function(a){return!!c[a]};this.event=function d(d){var f=c[d];return f?(f[0].apply(f[1],b.toArray(arguments).slice(1)),f[2]):false}}return function(g,a){var d={},f="";this.init=function(a){return d[a]?(f=a,
true):false};this.add=function(a){return d[a]?false:d[a]=new c};this.get=function(a){return d[a]};this.getCurrent=function(){return f};this.event=function(a){var c=d[f].event.apply(d[f].event,b.toArray(arguments));return c===false?false:(f=c||f,true)};b.loop(a,function(a,b){var c=this.add(b);a.forEach(function(a){c.add.apply(null,a)})},this);this.init(g)}});
define("Store",["Observable","Tools"],function(b,c){return function(g){var a=c.clone(g)||{},d=new b,f=function(b){var h=c.objectsDiffs(b,a);["updated","deleted","added"].forEach(function(b){h[b].forEach(function(e){d.notify(b,e,a[e])})})};this.getNbItems=function(){return a instanceof Array?a.length:c.count(a)};this.get=function(b){return a[b]};this.has=function(b){return a.hasOwnProperty(b)};this.set=function(b,c){var f;return typeof b!="undefined"?(f=this.has(b),a[b]=c,f?d.notify("updated",b,a[b]):
d.notify("added",b,a[b]),true):false};this.del=function(b){return this.has(b)?(this.alter("splice",b,1)||(delete a[b],d.notify("deleted",b)),true):false};this.alter=function(b){var d,g;return a[b]?(g=c.clone(a),d=a[b].apply(a,Array.prototype.slice.call(arguments,1)),f(g),d):false};this.watch=function(a,b,c){return d.watch(a,b,c)};this.unwatch=function(a){return d.unwatch(a)};this.loop=function(b,d){c.loop(a,b,d)};this.reset=function(b){if(b instanceof Object){var d=c.clone(a);a=c.clone(b)||{};f(d);
return true}else return false}}});
define("Tools",function(){return{getGlobal:function(){return function(){return this}.call(null)},mixin:function(b,c,g){this.loop(b,function(a,d){if(!c[d]||!g)c[d]=b[d]});return c},count:function(b){var c=0;this.loop(b,function(){c++});return c},compareObjects:function(b,c){return Object.getOwnPropertyNames(b).sort().join("")==Object.getOwnPropertyNames(c).sort().join("")},toArray:function(b){return Array.prototype.slice.call(b)},loop:function(b,c,g){var a;if(b instanceof Object&&typeof c=="function"){if(b instanceof
Array)b.forEach(c,g);else for(a in b)b.hasOwnProperty(a)&&c.call(g,b[a],a,b);return true}else return false},objectsDiffs:function(b,c){if(b instanceof Object&&c instanceof Object){var g=[],a=[],d=[],f=[];this.loop(c,function(d,c){d!==b[c]&&typeof b[c]!="undefined"?a.push(c):d===b[c]?g.push(c):typeof b[c]=="undefined"&&f.push(c)});this.loop(b,function(a,b){typeof c[b]=="undefined"&&d.push(b)});return{updated:a,unchanged:g,added:f,deleted:d}}else return false},jsonify:function(b){return b instanceof
Object?JSON.parse(JSON.stringify(b)):false},clone:function(b){return b instanceof Array?b.slice(0):typeof b=="object"&&b!==null&&!(b instanceof RegExp)?this.mixin(b,{}):b}}});
define("Transport",function(){return function(b){var c,g=io;this.connect=function(a){c=g.connect(a);return!!c};this.getSocket=function(){return c};this.on=function(a,b){c.on(a,b)};this.once=function(a,b){c.once(a,b)};this.emit=function(a,b,f){c.emit(a,b,f)};this.request=function(a,b,f,e){var g=Date.now()+Math.floor(Math.random()*1E6),j=function(){f.apply(e||null,arguments)};c[b.keptAlive?"on":"once"](g,j);b.__eventId__=g;c.emit(a,b);if(b.keptAlive)return{stop:function(){c.removeListener(g,j)}}};this.listen=
function(a,b,c,e){b.keptAlive=true;return this.request(a,b,c,e)};this.connect(b)}});
