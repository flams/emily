define("CouchDBStore",["Store","StateMachine","Tools"],function(b,c){function e(){var a=null,d=null,e=null,f=null,b=null,i={},h=new c("Unsynched",{Unsynched:[["getView",function(){a.request("CouchDB",{method:"GET",path:"/"+d+"/_design/"+b+"/_view/"+e+"?update_seq=true"},function(a){a=JSON.parse(a);i={total_rows:a.total_rows,update_seq:a.update_seq,offset:a.offset};this.reset(a.rows);h.event("subscribeToViewChanges",a.update_seq)},this)},this,"Synched"],["getDocument",function(){a.request("CouchDB",
{method:"GET",path:"/"+d+"/"+f},function(a){a=JSON.parse(a);a._id&&(this.reset(a),h.event("subscribeToDocumentChanges"))},this)},this,"Synched"]],Synched:[["updateDatabase",function(){a.request("CouchDB",{method:"PUT",path:"/"+d+"/"+f,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(){h.event("subscribeToDocumentChanges")})},this],["subscribeToViewChanges",function(f){a.listen("CouchDB","/"+d+"/_changes?feed=continuous&heartbeat=20000&since="+f,function(a){if(a=="\n")return false;
var a=JSON.parse(a),f;f=a.deleted?"delete":a.changes[0].rev.search("1-")==0?"add":"change";h.event(f,a.id)},this)},this,"Listening"],["subscribeToDocumentChanges",function(){a.listen("CouchDB","/"+d+"/_changes?feed=continuous&heartbeat=20000",function(a){if(a=="\n")return false;a=JSON.parse(a);a.id==f&&(a.deleted?h.event("deleteDoc"):h.event("updateDoc"))},this)},this,"Listening"]],Listening:[["change",function(f){a.request("CouchDB",{method:"GET",path:"/"+d+"/_design/"+b+"/_view/"+e},function(a){JSON.parse(a).rows.some(function(a,
d){a.id==f&&this.set(d,a)},this)},this)},this],["delete",function(a){this.loop(function(f,d){f.id==a&&this.del(d)},this)},this],["add",function(f){a.request("CouchDB",{method:"GET",path:"/"+d+"/_design/"+b+"/_view/"+e},function(a){JSON.parse(a).rows.some(function(a,d){a.id==f&&this.alter("splice",d,0,a)},this)},this)},this],["updateDoc",function(){a.request("CouchDB",{method:"GET",path:"/"+d+"/"+f},function(a){this.reset(JSON.parse(a))},this)},this],["deleteDoc",function(){this.reset({})},this],["updateDatabase",
function(){a.request("CouchDB",{method:"PUT",path:"/"+d+"/"+f,headers:{"Content-Type":"application/json"},data:this.toJSON()})},this]]});this.sync=function(a,c,i){if(typeof a=="string"&&typeof c=="string"&&typeof i=="string")return d=a,b=c,e=i,h.event("getView"),true;else if(typeof a=="string"&&typeof c=="string"&&typeof i=="undefined")return d=a,f=c,h.event("getDocument"),true;return false};this.update=function(){return h.event("updateDatabase")};this.getDBInfo=function(a){return i[a]};this.setTransport=
function(f){return f&&typeof f.listen=="function"&&typeof f.request=="function"?(a=f,true):false};this.getStateMachine=function(){return h};this.getTransport=function(){return a}}return function(){e.prototype=new b;return new e}});
define("Observable",["Tools"],function(b){return function(){var c={};this.watch=function(e,a,d){if(typeof a=="function"){var b=c[e]=c[e]||[];observer=[a,d];b.push(observer);return[e,b.indexOf(observer)]}else return false};this.unwatch=function(b){var a=b[0],b=b[1];return c[a]&&c[a][b]?(delete c[a][b],c[a].some(function(a){return!!a})||delete c[a],true):false};this.notify=function(e){var a=c[e],d;if(a){for(d=a.length;d--;)a[d]&&a[d][0].apply(a[d][1]||null,b.toArray(arguments).slice(1));return true}else return false};
this.hasObserver=function(b){return!(!b||!c[b[0]]||!c[b[0]][b[1]])};this.hasTopic=function(b){return!!c[b]};this.unwatchAll=function(b){c[b]?delete c[b]:c={};return true}}});
define("Promise",["StateMachine","Observable","Tools"],function(b,c,e){return function(a,d){var g=null,f=null,j=null,i=null,h=new c;_stateMachine=new b("Unresolved",{Unresolved:[["resolve",function(){g.call(f,function(){return _stateMachine.event.apply(_stateMachine,e.toArray(arguments))})}],["success",function(a){j=a;h.notify("success",a)},"Resolved"],["fail",function(a){i=a;h.notify("fail",a)},"Failed"],["addThen",function(a,f,b){h.watch(a,f,b)}]],Resolved:[["addThen",function(a,f,b){f.call(b,a==
"success"?j:i)}]],Failed:[["addThen",function(a,f,b){f.call(b,a=="success"?j:i)}]]});this.then=function(a,f,b,d){a instanceof Function&&(f instanceof Function?_stateMachine.event("addThen","success",f):_stateMachine.event("addThen","success",a,f));f instanceof Function&&_stateMachine.event("addThen","fail",f,b);b instanceof Function&&_stateMachine.event("addThen","fail",b,d)};this.resolve=function(){return!(!g||!_stateMachine.event("resolve"))};this.getState=function(){return _stateMachine.getCurrent()};
a instanceof Function&&(g=a,f=d)}});
define("StateMachine",["Tools"],function(b){function c(){var c={};this.add=function(a,b,g,f){var j=[];if(c[a])return false;return typeof a=="string"&&typeof b=="function"?(j[0]=b,typeof g=="object"&&(j[1]=g),typeof g=="string"&&(j[2]=g),typeof f=="string"&&(j[2]=f),c[a]=j,true):false};this.has=function(a){return!!c[a]};this.event=function d(d){var g=c[d];return g?(g[0].apply(g[1],b.toArray(arguments).slice(1)),g[2]):false}}return function(e,a){var d={},g="";this.init=function(a){return d[a]?(g=a,
true):false};this.add=function(a){return d[a]?false:d[a]=new c};this.get=function(a){return d[a]};this.getCurrent=function(){return g};this.event=function(a){var c=d[g].event.apply(d[g].event,b.toArray(arguments));return c===false?false:(g=c||g,true)};b.loop(a,function(a,b){var d=this.add(b);a.forEach(function(a){d.add.apply(null,a)})},this);this.init(e)}});
define("Store",["Observable","Tools"],function(b,c){return function(e){var a=c.clone(e)||{},d=new b,g=function(b){var e=c.objectsDiffs(b,a);["updated","deleted","added"].forEach(function(b){e[b].forEach(function(f){d.notify(b,f,a[f])})})};this.getNbItems=function(){return a instanceof Array?a.length:c.count(a)};this.get=function(b){return a[b]};this.has=function(b){return a.hasOwnProperty(b)};this.set=function(b,c){var e;return typeof b!="undefined"?(e=this.has(b),a[b]=c,e?d.notify("updated",b,a[b]):
d.notify("added",b,a[b]),true):false};this.del=function(b){return this.has(b)?(this.alter("splice",b,1)||(delete a[b],d.notify("deleted",b)),true):false};this.alter=function(b){var d,e;return a[b]?(e=c.clone(a),d=a[b].apply(a,Array.prototype.slice.call(arguments,1)),g(e),d):false};this.watch=function(a,b,c){return d.watch(a,b,c)};this.unwatch=function(a){return d.unwatch(a)};this.loop=function(b,d){c.loop(a,b,d)};this.reset=function(b){if(b instanceof Object){var d=c.clone(a);a=c.clone(b)||{};g(d);
return true}else return false};this.toJSON=function(){return JSON.stringify(a)}}});
define("Tools",function(){return{getGlobal:function(){return function(){return this}.call(null)},mixin:function(b,c,e){this.loop(b,function(a,d){if(!c[d]||!e)c[d]=b[d]});return c},count:function(b){var c=0;this.loop(b,function(){c++});return c},compareObjects:function(b,c){return Object.getOwnPropertyNames(b).sort().join("")==Object.getOwnPropertyNames(c).sort().join("")},toArray:function(b){return Array.prototype.slice.call(b)},loop:function(b,c,e){var a,d;if(b instanceof Object&&typeof c=="function"){if(d=
b.length)for(a=0;a<d;a++)c.call(e,b[a],a,b);else for(a in b)b.hasOwnProperty(a)&&c.call(e,b[a],a,b);return true}else return false},objectsDiffs:function(b,c){if(b instanceof Object&&c instanceof Object){var e=[],a=[],d=[],g=[];this.loop(c,function(d,c){d!==b[c]&&typeof b[c]!="undefined"?a.push(c):d===b[c]?e.push(c):typeof b[c]=="undefined"&&g.push(c)});this.loop(b,function(a,b){typeof c[b]=="undefined"&&d.push(b)});return{updated:a,unchanged:e,added:g,deleted:d}}else return false},jsonify:function(b){return b instanceof
Object?JSON.parse(JSON.stringify(b)):false},clone:function(b){return b instanceof Array?b.slice(0):typeof b=="object"&&b!==null&&!(b instanceof RegExp)?this.mixin(b,{}):b},getObjectsProperty:function(b,c){if(b&&b instanceof Object&&typeof c=="string"&&c!=""){var e=c.split(".");e.unshift(b);return e.reduce(function(a,b){return a[b]})}else return b}}});
define("Transport",["Observable"],function(b){return function(c){var e=null,a=io,d=new b;this.connect=function(b){e=a.connect(b);return!!e};this.getSocket=function(){return e};this.on=function(a,b){e.on(a,b)};this.once=function(a,b){e.once(a,b)};this.emit=function(a,b,c){e.emit(a,b,c)};this.request=function(a,b,c,d){var h=Date.now()+Math.floor(Math.random()*1E6),k=function(){c&&c.apply(d||null,arguments)};e[b.keptAlive?"on":"once"](h,k);b.__eventId__=h;e.emit(a,b);if(b.keptAlive)return function(){e.removeListener(h,
k)}};this.listen=function(a,b,c,e){var h=a+"/"+b,k,l;d.hasTopic(h)||(l=this.request(a,{path:b,method:"GET",keptAlive:true},function(a){d.notify(h,a)},this));k=d.watch(h,c,e);return{stop:function(){d.unwatch(k);d.hasTopic(h)||l()}}};this.getListenObservable=function(){return d};this.connect(c)}});
