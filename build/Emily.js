define("CouchDBStore",["Store","StateMachine","Tools"],function(c,e){function f(){var a=null,d=null,f=null,b=null,i=null,c={},h=new e("Unsynched",{Unsynched:[["getView",function(){a.request("CouchDB",{method:"GET",path:"/"+d+"/_design/"+i+"/_view/"+f+"?update_seq=true"},function(b){b=JSON.parse(b);c={total_rows:b.total_rows,update_seq:b.update_seq,offset:b.offset};this.reset(b.rows);h.event("subscribeToViewChanges",b.update_seq)},this)},this,"Synched"],["getDocument",function(){a.request("CouchDB",
{method:"GET",path:"/"+d+"/"+b},function(b){b=JSON.parse(b);b._id&&(this.reset(b),h.event("subscribeToDocumentChanges"))},this)},this,"Synched"]],Synched:[["updateDatabase",function(){a.request("CouchDB",{method:"PUT",path:"/"+d+"/"+b,headers:{"Content-Type":"application/json"},data:this.toJSON()},function(){h.event("subscribeToDocumentChanges")})},this],["subscribeToViewChanges",function(b){a.listen("CouchDB","/"+d+"/_changes?feed=continuous&heartbeat=20000&since="+b,function(b){if(b=="\n")return false;
var b=JSON.parse(b),a;a=b.deleted?"delete":b.changes[0].rev.search("1-")==0?"add":"change";h.event(a,b.id)},this)},this,"Listening"],["subscribeToDocumentChanges",function(){a.listen("CouchDB","/"+d+"/_changes?feed=continuous&heartbeat=20000",function(a){if(a=="\n")return false;a=JSON.parse(a);a.id==b&&(a.deleted?h.event("deleteDoc"):h.event("updateDoc"))},this)},this,"Listening"]],Listening:[["change",function(b){a.request("CouchDB",{method:"GET",path:"/"+d+"/_design/"+i+"/_view/"+f},function(a){JSON.parse(a).rows.some(function(a,
d){a.id==b&&this.set(d,a)},this)},this)},this],["delete",function(b){this.loop(function(a,d){a.id==b&&this.del(d)},this)},this],["add",function(b){a.request("CouchDB",{method:"GET",path:"/"+d+"/_design/"+i+"/_view/"+f},function(a){JSON.parse(a).rows.some(function(a,d){a.id==b&&this.alter("splice",d,0,a)},this)},this)},this],["updateDoc",function(){a.request("CouchDB",{method:"GET",path:"/"+d+"/"+b},function(b){this.reset(JSON.parse(b))},this)},this],["deleteDoc",function(){this.reset({})},this],["updateDatabase",
function(){a.request("CouchDB",{method:"PUT",path:"/"+d+"/"+b,headers:{"Content-Type":"application/json"},data:this.toJSON()})},this],["removeFromDatabase",function(){a.request("CouchDB",{method:"DELETE",path:"/"+d+"/"+b+"?rev="+this.get("_rev")})},this]]});this.sync=function(a,c,e){if(typeof a=="string"&&typeof c=="string"&&typeof e=="string")return d=a,i=c,f=e,h.event("getView"),true;else if(typeof a=="string"&&typeof c=="string"&&typeof e=="undefined")return d=a,b=c,h.event("getDocument"),true;
return false};this.update=function(){return h.event("updateDatabase")};this.remove=function(){return h.event("removeFromDatabase")};this.getDBInfo=function(b){return c[b]};this.setTransport=function(b){return b&&typeof b.listen=="function"&&typeof b.request=="function"?(a=b,true):false};this.getStateMachine=function(){return h};this.getTransport=function(){return a}}return function(){f.prototype=new c;return new f}});
define("Observable",["Tools"],function(c){return function(){var e={};this.watch=function(c,a,d){if(typeof a=="function"){var g=e[c]=e[c]||[];observer=[a,d];g.push(observer);return[c,g.indexOf(observer)]}else return false};this.unwatch=function(c){var a=c[0],c=c[1];return e[a]&&e[a][c]?(delete e[a][c],e[a].some(function(a){return!!a})||delete e[a],true):false};this.notify=function(f){var a=e[f],d;if(a){for(d=a.length;d--;)a[d]&&a[d][0].apply(a[d][1]||null,c.toArray(arguments).slice(1));return true}else return false};
this.hasObserver=function(c){return!(!c||!e[c[0]]||!e[c[0]][c[1]])};this.hasTopic=function(c){return!!e[c]};this.unwatchAll=function(c){e[c]?delete e[c]:e={};return true}}});
define("Promise",["Observable","StateMachine"],function(c,e){return function(){var f,a,d=new e("Unresolved",{Unresolved:[["resolve",function(b){f=b;g.notify("success",b)},"Resolved"],["reject",function(b){a=b;g.notify("fail",b)},"Rejected"],["addSuccess",function(b,a){g.watch("success",b,a)}],["addFail",function(b,a){g.watch("fail",b,a)}]],Resolved:[["addSuccess",function(b,a){b.call(a,f)}]],Rejected:[["addFail",function(b,c){b.call(c,a)}]]}),g=new c;this.resolve=function(b){return d.event("resolve",
b)};this.reject=function(b){return d.event("reject",b)};this.then=function(b,a,c,e){b instanceof Function&&(a instanceof Function?d.event("addSuccess",b):d.event("addSuccess",b,a));a instanceof Function&&d.event("addFail",a,c);c instanceof Function&&d.event("addFail",c,e);return this};this.getObservable=function(){return g};this.getStateMachine=function(){return d}}});
define("StateMachine",["Tools"],function(c){function e(){var e={};this.add=function(a,c,g,b){var i=[];if(e[a])return false;return typeof a=="string"&&typeof c=="function"?(i[0]=c,typeof g=="object"&&(i[1]=g),typeof g=="string"&&(i[2]=g),typeof b=="string"&&(i[2]=b),e[a]=i,true):false};this.has=function(a){return!!e[a]};this.event=function d(d){var g=e[d];return g?(g[0].apply(g[1],c.toArray(arguments).slice(1)),g[2]):false}}return function(f,a){var d={},g="";this.init=function(b){return d[b]?(g=b,
true):false};this.add=function(b){return d[b]?false:d[b]=new e};this.get=function(b){return d[b]};this.getCurrent=function(){return g};this.event=function(b){var a=d[g].event.apply(d[g].event,c.toArray(arguments));return a===false?false:(g=a||g,true)};c.loop(a,function(b,a){var c=this.add(a);b.forEach(function(b){c.add.apply(null,b)})},this);this.init(f)}});
define("Store",["Observable","Tools"],function(c,e){return function(f){var a=e.clone(f)||{},d=new c,g=function(b){var c=e.objectsDiffs(b,a);["updated","deleted","added"].forEach(function(b){c[b].forEach(function(c){d.notify(b,c,a[c])})})};this.getNbItems=function(){return a instanceof Array?a.length:e.count(a)};this.get=function(b){return a[b]};this.has=function(b){return a.hasOwnProperty(b)};this.set=function(b,c){var e;return typeof b!="undefined"?(e=this.has(b),a[b]=c,e?d.notify("updated",b,a[b]):
d.notify("added",b,a[b]),true):false};this.del=function(b){return this.has(b)?(this.alter("splice",b,1)||(delete a[b],d.notify("deleted",b)),true):false};this.alter=function(b){var c,d;return a[b]?(d=e.clone(a),c=a[b].apply(a,Array.prototype.slice.call(arguments,1)),g(d),c):false};this.watch=function(b,a,c){return d.watch(b,a,c)};this.unwatch=function(b){return d.unwatch(b)};this.loop=function(b,c){e.loop(a,b,c)};this.reset=function(b){if(b instanceof Object){var c=e.clone(a);a=e.clone(b)||{};g(c);
return true}else return false};this.toJSON=function(){return JSON.stringify(a)}}});
define("Tools",function(){return{getGlobal:function(){return function(){return this}.call(null)},mixin:function(c,e,f){this.loop(c,function(a,d){if(!e[d]||!f)e[d]=c[d]});return e},count:function(c){var e=0;this.loop(c,function(){e++});return e},compareObjects:function(c,e){return Object.getOwnPropertyNames(c).sort().join("")==Object.getOwnPropertyNames(e).sort().join("")},toArray:function(c){return Array.prototype.slice.call(c)},loop:function(c,e,f){var a,d;if(c instanceof Object&&typeof e=="function"){if(d=
c.length)for(a=0;a<d;a++)e.call(f,c[a],a,c);else for(a in c)c.hasOwnProperty(a)&&e.call(f,c[a],a,c);return true}else return false},objectsDiffs:function(c,e){if(c instanceof Object&&e instanceof Object){var f=[],a=[],d=[],g=[];this.loop(e,function(b,d){b!==c[d]&&typeof c[d]!="undefined"?a.push(d):b===c[d]?f.push(d):typeof c[d]=="undefined"&&g.push(d)});this.loop(c,function(b,a){typeof e[a]=="undefined"&&d.push(a)});return{updated:a,unchanged:f,added:g,deleted:d}}else return false},jsonify:function(c){return c instanceof
Object?JSON.parse(JSON.stringify(c)):false},clone:function(c){return c instanceof Array?c.slice(0):typeof c=="object"&&c!==null&&!(c instanceof RegExp)?this.mixin(c,{}):c},getObjectsProperty:function(c,e){if(c&&c instanceof Object&&typeof e=="string"&&e!=""){var f=e.split(".");f.unshift(c);return f.reduce(function(a,c){return a[c]})}else return c}}});
define("Transport",["Observable"],function(c){return function(e){var f=null,a=io,d=new c;this.connect=function(c){f=a.connect(c);return!!f};this.getSocket=function(){return f};this.on=function(a,b){f.on(a,b)};this.once=function(a,b){f.once(a,b)};this.emit=function(a,b,c){f.emit(a,b,c)};this.request=function(a,b,c,d){var e=Date.now()+Math.floor(Math.random()*1E6),j=function(){c&&c.apply(d||null,arguments)};f[b.keptAlive?"on":"once"](e,j);b.__eventId__=e;f.emit(a,b);if(b.keptAlive)return function(){f.removeListener(e,
j)}};this.listen=function(a,b,c,e){var f=a+"/"+b,j,k;d.hasTopic(f)||(k=this.request(a,{path:b,method:"GET",keptAlive:true},function(a){d.notify(f,a)},this));j=d.watch(f,c,e);return{stop:function(){d.unwatch(j);d.hasTopic(f)||k()}}};this.getListenObservable=function(){return d};this.connect(e)}});
